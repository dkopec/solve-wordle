@page "/"
@inject WordListService WordListService
@inject IJSRuntime JS

<PageTitle>Wordle Solver</PageTitle>

<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="mb-2">Wordle Solver</h1>
            <p class="lead mb-0">Enter your Wordle clues to find possible words!</p>
        </div>
        <button type="button" class="btn btn-outline-secondary" @onclick="ToggleDarkMode" id="darkModeToggle">
            <i class="bi @(isDarkMode ? "bi-sun-fill" : "bi-moon-stars-fill")"></i>
        </button>
    </div>

    @if (!isInitialized)
    {
        <div class="alert alert-info">
            <div class="spinner-border spinner-border-sm me-2" role="status"></div>
            Loading word lists...
        </div>
    }

    <div class="row">
        <div class="col-lg-5 col-xl-4 mb-4">
            <div class="sticky-top" style="top: 20px;">
            <div class="mb-4" id="wordleForm">
                <div class="mb-3">
                    <label class="form-label">Correct Letters (Green)</label>
                    <div class="d-flex gap-2 mb-2" id="letterBoxes">
                        @for (int i = 0; i < 5; i++)
                        {
                            int index = i;
                            <input type="text" 
                                   class="form-control text-center letter-box" 
                                   maxlength="1" 
                                   id="@($"correct-{index}")"
                                   value="@(correctLetters[index])"
                                   @oninput="@((e) => OnCorrectLetterInput(index, e))"
                                   @onkeydown="@((e) => OnCorrectLetterKeyDown(index, e))"
                                   @onfocus="@((e) => OnInputFocus(e))"
                                   style="width: 60px; height: 60px; font-size: 24px; font-weight: bold; text-transform: uppercase;" />
                        }
                    </div>
                    <small class="form-text text-muted">Enter known letters in their correct positions. Leave blank for unknown positions.</small>
                </div>

                <div class="mb-3">
                    <label class="form-label">Wrong Position Letters (Yellow)</label>
                    <div id="wrongPositionRows">
                        @for (int rowIdx = 0; rowIdx < wrongPositionRows.Count; rowIdx++)
                        {
                            int currentRow = rowIdx;
                            <div class="d-flex gap-2 mb-2 align-items-center wrong-pos-row">
                                <div class="d-flex gap-2">
                                    @for (int i = 0; i < 5; i++)
                                    {
                                        int pos = i;
                                        <input type="text" 
                                               class="form-control text-center wrong-pos-box" 
                                               maxlength="1"
                                               id="@($"wrong-{currentRow}-{pos}")"
                                               value="@wrongPositionRows[currentRow][pos]"
                                               @oninput="@((e) => OnWrongPosInput(currentRow, pos, e))"
                                               @onkeydown="@((e) => OnWrongPosKeyDown(currentRow, pos, e))"
                                               @onfocus="@((e) => OnInputFocus(e))"
                                               style="width: 50px; height: 50px; font-size: 20px; font-weight: bold; text-transform: uppercase;" />
                                    }
                                </div>
                                <button type="button" class="btn btn-sm btn-outline-danger" @onclick="() => RemoveWrongPosRow(currentRow)">
                                    Ã—
                                </button>
                            </div>
                        }
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-secondary mt-2" @onclick="AddWrongPosRow">
                        + Add Row
                    </button>
                    <small class="form-text text-muted d-block mt-2">For each yellow letter, enter it in the position(s) where it appeared but was wrong. Multiple rows let you track different guesses.</small>
                </div>

                <div class="mb-3">
                    <label class="form-label">Excluded Letters (Gray)</label>
                    <div id="excludedLetterBoxes">
                        @for (int rowIdx = 0; rowIdx < excludedLetterRows.Count; rowIdx++)
                        {
                            int currentRow = rowIdx;
                            <div class="d-flex gap-2 mb-2 align-items-center excluded-letter-row">
                                <div class="d-flex gap-2">
                                    @for (int i = 0; i < 5; i++)
                                    {
                                        int pos = i;
                                        <input type="text" 
                                               class="form-control text-center excluded-letter-box" 
                                               maxlength="1"
                                               id="@($"excluded-{currentRow}-{pos}")"
                                               value="@excludedLetterRows[currentRow][pos]"
                                               @oninput="@((e) => OnExcludedLetterInput(currentRow, pos, e))"
                                               @onkeydown="@((e) => OnExcludedLetterKeyDown(currentRow, pos, e))"
                                               @onfocus="@((e) => OnInputFocus(e))"
                                               style="width: 50px; height: 50px; font-size: 20px; font-weight: bold; text-transform: uppercase;" />
                                    }
                                </div>
                            </div>
                        }
                    </div>
                    <small class="form-text text-muted d-block mt-2">Enter letters that are not in the word at all. New rows will appear automatically as you type.</small>
                </div>

                <div class="mb-3 form-check">
                    <input type="checkbox" class="form-check-input" id="excludePastAnswers" @bind="excludePastAnswers" />
                    <label class="form-check-label" for="excludePastAnswers">
                        Exclude previous Wordle answers
                    </label>
                    <small class="form-text text-muted d-block">
                        Note: While Wordle rarely reuses past answers, it can happen. Uncheck this if you're not finding expected words.
                    </small>
                </div>

                <div class="d-flex gap-2">
                    <button type="button" class="btn btn-primary" @onclick="FindWords">
                        <i class="bi bi-search"></i> Find Words
                    </button>
                    <button type="button" class="btn btn-outline-secondary" @onclick="Reset">
                        <i class="bi bi-arrow-counterclockwise"></i> Reset
                    </button>
                </div>
            </div>
            </div>
        </div>

        <div class="col-lg-7 col-xl-8">
            @if (solver != null && bestStartingWords.Any() && possibleWords == null)
            {
                <div class="alert alert-info mb-4">
                    <h6 class="alert-heading mb-2"><i class="bi bi-lightbulb"></i> Best Starting Words:</h6>
                    <div class="d-flex flex-wrap gap-2">
                        @foreach (var word in bestStartingWords)
                        {
                            <span class="badge bg-primary fs-6 cursor-pointer starting-word" 
                                  style="cursor: pointer;" 
                                  title="Click to use this word"
                                  @onclick="() => UseStartingWord(word)">
                                @word.ToUpper()
                            </span>
                        }
                    </div>
                    <small class="text-muted d-block mt-2">These words are statistically most likely to help you solve the puzzle based on past Wordle answers.</small>
                </div>

                @if (!string.IsNullOrEmpty(guessInOne))
                {
                    <div class="alert alert-success mb-4 border-3 border-success">
                        <h5 class="alert-heading mb-3">
                            <i class="bi bi-trophy-fill text-warning"></i> <strong>Feeling Lucky? Guess in One!</strong>
                        </h5>
                        <div class="text-center py-3">
                            <div class="mb-3">
                                <span class="badge bg-success text-white fs-1 px-5 py-3 shadow-lg" 
                                      id="guessInOneWord" 
                                      style="font-family: monospace; letter-spacing: 8px; cursor: pointer;" 
                                      title="Click to copy"
                                      @onclick="() => CopyToClipboard(guessInOne.ToUpper())">
                                    @guessInOne.ToUpper()
                                </span>
                            </div>
                            <div class="mb-3">
                                <button type="button" class="btn btn-outline-success" @onclick="RefreshGuessInOne">
                                    <i class="bi bi-arrow-clockwise"></i> Try Another Word
                                </button>
                            </div>
                            <small class="text-muted">
                                <i class="bi bi-info-circle"></i> This is today's top statistical pick from past Wordle answers. 
                                Click the word to copy, or try another suggestion!
                            </small>
                        </div>
                    </div>
                }
            }
            
            @if (possibleWords != null && possibleWords.Any())
            {
                <div class="alert alert-success d-flex justify-content-between align-items-center">
                    <div>
                        <h4 class="mb-1">
                            <i class="bi bi-check-circle-fill"></i> 
                            Found @possibleWords.Count possible word@(possibleWords.Count != 1 ? "s" : "")
                        </h4>
                        <small class="text-muted">Ranked by statistical likelihood - Top suggestion is most probable</small>
                    </div>
                    @if (possibleWords.Count == 1)
                    {
                        <span class="badge bg-success fs-5 px-4 py-2">
                            <i class="bi bi-trophy-fill"></i> SOLVED!
                        </span>
                    }
                    else if (possibleWords.Count <= 5)
                    {
                        <span class="badge bg-success fs-5 px-4 py-2">
                            <i class="bi bi-bullseye"></i> CLOSE!
                        </span>
                    }
                    else if (possibleWords.Count <= 20)
                    {
                        <span class="badge bg-warning fs-5 px-4 py-2">
                            <i class="bi bi-funnel"></i> NARROWING
                        </span>
                    }
                </div>
                
                @if (strategicWords != null && strategicWords.Any() && possibleWords.Count > 1)
                {
                    <div class="alert alert-warning mb-3">
                        <h5 class="alert-heading mb-3">
                            <i class="bi bi-lightbulb-fill"></i> Strategic Play Option
                        </h5>
                        @if (possibleWords.Count > 10)
                        {
                            <p class="mb-2">
                                <strong>With @possibleWords.Count possibilities remaining, a "throwaway word" is recommended</strong> to eliminate more options faster.
                                These words won't be the answer, but they'll give you maximum information:
                            </p>
                        }
                        else if (possibleWords.Count > 3)
                        {
                            <p class="mb-2">
                                <strong>@possibleWords.Count possibilities remain.</strong> You can try the top-ranked word, or use a strategic word to narrow further:
                            </p>
                        }
                        else
                        {
                            <p class="mb-2">
                                <strong>Only @possibleWords.Count option@(possibleWords.Count != 1 ? "s" : "") left!</strong> Try the top word, or use strategic play to confirm:
                            </p>
                        }
                        <div class="d-flex flex-wrap gap-2 mt-3">
                            @foreach (var strategic in strategicWords)
                            {
                                <span class="badge bg-warning text-dark fs-6 px-3 py-2" style="cursor: pointer;" 
                                      title="Try this word to eliminate the most possibilities">
                                    <i class="bi bi-gear-fill"></i> @strategic.Word.ToUpper()
                                </span>
                            }
                        </div>
                        <small class="text-muted d-block mt-2">
                            <i class="bi bi-info-circle"></i> <strong>Smart strategy:</strong> These words avoid your green letters and test the most uncertain variables.
                            @if (possibleWords.Count > 5)
                            {
                                <text>After trying one, you'll dramatically narrow down the possibilities!</text>
                            }
                            else
                            {
                                <text>Use these to confidently confirm the answer or eliminate remaining options.</text>
                            }
                        </small>
                    </div>
                }
                
                @if (possibleWords.Count > 1 && possibleWords.Count <= 3 && possibleWords.First().ConfidencePercentage >= 75)
                {
                    <div class="alert alert-info mb-3">
                        <strong><i class="bi bi-stars"></i> Strong recommendation:</strong> 
                        Try "<strong class="text-uppercase fs-5">@possibleWords.First().Word</strong>" 
                        (@possibleWords.First().ConfidencePercentage.ToString("F1")% confidence)
                    </div>
                }
                else if (possibleWords.Count > 3 && possibleWords.Count <= 5)
                {
                    <div class="alert alert-success mb-3">
                        <i class="bi bi-target"></i> <strong>You're close!</strong> Try the top-ranked word below, or if unsure, use a strategic word above to narrow further.
                    </div>
                }
                
                <div class="list-group mb-3">
                    @foreach (var suggestion in possibleWords.Take(50))
                    {
                        var confidenceClass = suggestion.ConfidencePercentage >= 70 ? "success" : 
                                             suggestion.ConfidencePercentage >= 50 ? "info" :
                                             suggestion.ConfidencePercentage >= 30 ? "warning" : "secondary";
                        var progressWidth = Math.Round(suggestion.ConfidencePercentage, 0);
                        var isTopPick = suggestion.Rank == 1;
                        var borderClass = isTopPick && suggestion.ConfidencePercentage >= 70 ? "border-success border-3" : "";
                        var bgClass = isTopPick && suggestion.ConfidencePercentage >= 70 ? "top-pick-highlight" : "";
                        
                        <div class="list-group-item d-flex justify-content-between align-items-center mb-2 @borderClass @bgClass">
                            <div class="d-flex align-items-center" style="min-width: 220px;">
                                <span class="badge @(isTopPick ? "bg-success" : "bg-dark") me-3" style="font-size: 0.9rem; min-width: 35px;">
                                    @if (isTopPick)
                                    {
                                        <i class="bi bi-star-fill"></i>
                                    }
                                    else
                                    {
                                        @("#" + suggestion.Rank)
                                    }
                                </span>
                                <strong class="fs-5 text-uppercase" style="font-family: monospace; letter-spacing: 2px; @(isTopPick ? "font-weight: bold; font-size: 1.5rem !important;" : "")">
                                    @suggestion.Word
                                </strong>
                                @if (isTopPick && suggestion.ConfidencePercentage >= 75)
                                {
                                    <span class="ms-2 text-success"><i class="bi bi-arrow-left-circle-fill"></i> BEST</span>
                                }
                            </div>
                            <div class="d-flex align-items-center flex-grow-1 ms-4">
                                <div class="progress flex-grow-1 me-3" style="height: 25px; max-width: 300px;">
                                    <div class="progress-bar bg-@confidenceClass @(isTopPick ? "progress-bar-striped progress-bar-animated" : "")" role="progressbar" 
                                         style="width: @(progressWidth)%" 
                                         aria-valuenow="@progressWidth" aria-valuemin="0" aria-valuemax="100">
                                        <strong>@suggestion.ConfidencePercentage.ToString("F1")%</strong>
                                    </div>
                                </div>
                                <span class="badge bg-@confidenceClass" style="min-width: 70px; font-size: 0.95rem;">@suggestion.ConfidencePercentage.ToString("F1")%</span>
                            </div>
                        </div>
                    }
                </div>
                @if (possibleWords.Count > 50)
                {
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i> Showing top 50 of <strong>@possibleWords.Count</strong> words. 
                        Add more clues to narrow down the results. Focus on the top-ranked suggestions.
                    </div>
                }
            }
            else if (possibleWords != null)
            {
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle"></i> No matching words found. Try adjusting your clues.
                </div>
            }
        </div>
    </div>
</div>

@code {
    private bool isInitialized = false;
    private WordleSolver? solver;
    private List<string> bestStartingWords = new();
    private string? guessInOne;
    private int guessInOneOffset = 0;

    private string[] correctLetters = new string[5] { "", "", "", "", "" };
    private List<string[]> wrongPositionRows = new();
    private List<string[]> excludedLetterRows = new();
    private bool excludePastAnswers = false;

    private List<WordSuggestion>? possibleWords;
    private List<WordSuggestion>? strategicWords;

    protected override async Task OnInitializedAsync()
    {
        // Initialize word list service
        await WordListService.InitializeAsync();
        
        // Create solver instance
        solver = new WordleSolver(
            WordListService.GetWords(),
            WordListService.GetPastAnswers(),
            WordListService.GetCommonWords()
        );

        bestStartingWords = solver.GetBestStartingWords(5);
        guessInOne = solver.GetGuessInOne();

        // Initialize with one empty row each
        wrongPositionRows.Add(new string[5] { "", "", "", "", "" });
        excludedLetterRows.Add(new string[5] { "", "", "", "", "" });

        isInitialized = true;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                // Load theme preference
                var theme = await JS.InvokeAsync<string>("localStorage.getItem", "theme");
                isDarkMode = theme == "dark";
                await ApplyTheme();
                StateHasChanged();
            }
            catch
            {
                // localStorage not available
            }

            // Setup auto-focus
            try
            {
                await JS.InvokeVoidAsync("setupAutoFocus");
            }
            catch
            {
                // Function not available yet
            }
        }
        else
        {
            // Re-setup auto-focus after state changes
            try
            {
                await JS.InvokeVoidAsync("setupAutoFocus");
            }
            catch
            {
                // Function not available
            }
        }
    }

    private void OnCorrectLetterInput(int index, ChangeEventArgs e)
    {
        var value = e.Value?.ToString()?.ToUpper() ?? "";
        if (value.Length > 0 && !char.IsLetter(value[0]))
        {
            correctLetters[index] = "";
            return;
        }
        correctLetters[index] = value.Length > 0 ? value.Substring(0, 1) : "";
    }

    private async Task OnCorrectLetterKeyDown(int index, KeyboardEventArgs e)
    {
        if (e.Key == "Backspace" && string.IsNullOrEmpty(correctLetters[index]) && index > 0)
        {
            await JS.InvokeVoidAsync("focusElement", $"correct-{index - 1}");
        }
        else if (e.Key == "ArrowLeft" && index > 0)
        {
            await JS.InvokeVoidAsync("focusElement", $"correct-{index - 1}");
        }
        else if (e.Key == "ArrowRight" && index < 4)
        {
            await JS.InvokeVoidAsync("focusElement", $"correct-{index + 1}");
        }
    }

    private void OnWrongPosInput(int row, int pos, ChangeEventArgs e)
    {
        var value = e.Value?.ToString()?.ToUpper() ?? "";
        if (value.Length > 0 && !char.IsLetter(value[0]))
        {
            wrongPositionRows[row][pos] = "";
            return;
        }
        wrongPositionRows[row][pos] = value.Length > 0 ? value.Substring(0, 1) : "";
    }

    private async Task OnWrongPosKeyDown(int row, int pos, KeyboardEventArgs e)
    {
        if (e.Key == "Backspace" && string.IsNullOrEmpty(wrongPositionRows[row][pos]) && pos > 0)
        {
            await JS.InvokeVoidAsync("focusElement", $"wrong-{row}-{pos - 1}");
        }
        else if (e.Key == "ArrowLeft" && pos > 0)
        {
            await JS.InvokeVoidAsync("focusElement", $"wrong-{row}-{pos - 1}");
        }
        else if (e.Key == "ArrowRight" && pos < 4)
        {
            await JS.InvokeVoidAsync("focusElement", $"wrong-{row}-{pos + 1}");
        }
    }

    private void AddWrongPosRow()
    {
        wrongPositionRows.Add(new string[5] { "", "", "", "", "" });
    }

    private void RemoveWrongPosRow(int index)
    {
        if (wrongPositionRows.Count > 1)
        {
            wrongPositionRows.RemoveAt(index);
        }
    }

    private void OnExcludedLetterInput(int row, int pos, ChangeEventArgs e)
    {
        var value = e.Value?.ToString()?.ToUpper() ?? "";
        if (value.Length > 0 && !char.IsLetter(value[0]))
        {
            excludedLetterRows[row][pos] = "";
            return;
        }

        // Check for duplicates in correct or wrong positions
        var letter = value.Length > 0 ? value.Substring(0, 1) : "";
        if (!string.IsNullOrEmpty(letter))
        {
            if (correctLetters.Any(l => l.Equals(letter, StringComparison.OrdinalIgnoreCase)))
            {
                excludedLetterRows[row][pos] = "";
                return;
            }

            var allWrongPos = wrongPositionRows.SelectMany(r => r).Where(l => !string.IsNullOrEmpty(l));
            if (allWrongPos.Any(l => l.Equals(letter, StringComparison.OrdinalIgnoreCase)))
            {
                excludedLetterRows[row][pos] = "";
                return;
            }
        }

        excludedLetterRows[row][pos] = letter;

        // Auto-add new row if last position of last row
        if (!string.IsNullOrEmpty(letter) && row == excludedLetterRows.Count - 1 && pos == 4)
        {
            excludedLetterRows.Add(new string[5] { "", "", "", "", "" });
        }
    }

    private async Task OnExcludedLetterKeyDown(int row, int pos, KeyboardEventArgs e)
    {
        if (e.Key == "Backspace" && string.IsNullOrEmpty(excludedLetterRows[row][pos]))
        {
            if (pos > 0)
            {
                await JS.InvokeVoidAsync("focusElement", $"excluded-{row}-{pos - 1}");
            }
            else if (row > 0)
            {
                await JS.InvokeVoidAsync("focusElement", $"excluded-{row - 1}-4");
            }
        }
        else if (e.Key == "ArrowLeft" && pos > 0)
        {
            await JS.InvokeVoidAsync("focusElement", $"excluded-{row}-{pos - 1}");
        }
        else if (e.Key == "ArrowRight" && pos < 4)
        {
            await JS.InvokeVoidAsync("focusElement", $"excluded-{row}-{pos + 1}");
        }
    }

    private async Task OnInputFocus(FocusEventArgs e)
    {
        // Handled by JavaScript
    }

    private void FindWords()
    {
        if (solver == null) return;

        // Build correct positions string
        var correctPositions = string.Join("", correctLetters.Select(l => string.IsNullOrEmpty(l) ? "_" : l.ToLower()));

        // Build wrong positions string
        var wrongPositionsList = new List<string>();
        for (int row = 0; row < wrongPositionRows.Count; row++)
        {
            for (int pos = 0; pos < 5; pos++)
            {
                var letter = wrongPositionRows[row][pos];
                if (!string.IsNullOrEmpty(letter))
                {
                    wrongPositionsList.Add($"{letter.ToLower()}:{pos + 1}");
                }
            }
        }
        var wrongPositions = string.Join(", ", wrongPositionsList);

        // Build excluded letters string
        var excludedLetters = string.Join("", excludedLetterRows.SelectMany(r => r).Where(l => !string.IsNullOrEmpty(l)).Select(l => l.ToLower()));

        // Get results
        possibleWords = solver.GetRankedSuggestions(
            correctPositions,
            wrongPositions,
            excludedLetters,
            excludePastAnswers
        );

        // Get strategic words
        if (possibleWords != null && possibleWords.Any())
        {
            var possibleWordsList = possibleWords.Select(w => w.Word).ToList();
            strategicWords = solver.GetStrategicWords(
                possibleWordsList,
                correctPositions,
                excludedLetters,
                5
            );
        }
    }

    private void Reset()
    {
        correctLetters = new string[5] { "", "", "", "", "" };
        wrongPositionRows = new() { new string[5] { "", "", "", "", "" } };
        excludedLetterRows = new() { new string[5] { "", "", "", "", "" } };
        possibleWords = null;
        strategicWords = null;
    }

    private void UseStartingWord(string word)
    {
        for (int i = 0; i < 5 && i < word.Length; i++)
        {
            correctLetters[i] = word[i].ToString().ToUpper();
        }
    }

    private void RefreshGuessInOne()
    {
        if (solver == null) return;
        guessInOneOffset++;
        guessInOne = solver.GetGuessInOne(guessInOneOffset);
    }

    private async Task CopyToClipboard(string text)
    {
        try
        {
            await JS.InvokeVoidAsync("navigator.clipboard.writeText", text);
        }
        catch
        {
            // Clipboard API not available
        }
    }

    private bool isDarkMode = false;

    private async Task ToggleDarkMode()
    {
        isDarkMode = !isDarkMode;
        await ApplyTheme();
        try
        {
            await JS.InvokeVoidAsync("localStorage.setItem", "theme", isDarkMode ? "dark" : "light");
        }
        catch
        {
            // localStorage not available
        }
    }

    private async Task ApplyTheme()
    {
        try
        {
            await JS.InvokeVoidAsync("eval", $"document.documentElement.setAttribute('data-bs-theme', '{(isDarkMode ? "dark" : "light")}')");
        }
        catch
        {
            // DOM manipulation not available
        }
    }
}
